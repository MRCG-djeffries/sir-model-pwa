<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shiny App</title>

  <!-- Register Shinylive SW explicitly -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        await navigator.serviceWorker.register("/sir-model-pwa/shinylive-sw.js", {
          scope: "/sir-model-pwa/"
        });
      });
    }
  </script>

  <link rel="manifest" href="/sir-model-pwa/manifest.json">

  <!-- Shinylive app bootstrap -->
  <script type="module">
    import { runExportedApp } from "/sir-model-pwa/shinylive/shinylive.js";
    runExportedApp({
      id: "root",
      appEngine: "r",
      appJsonPath: "/sir-model-pwa/app.json",
      relPath: "/sir-model-pwa/",
    });
  </script>

  <link rel="stylesheet" href="/sir-model-pwa/shinylive/style-resets.css" />
  <link rel="stylesheet" href="/sir-model-pwa/shinylive/shinylive.css" />
</head>

<body>
  <!-- Status bar -->
  <div id="pwa-status" style="
    position: fixed; top: 0; left: 0; right: 0;
    padding: 6px 10px;
    font: 12px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: rgba(245,245,245,0.95);
    border-bottom: 1px solid #ddd;
    z-index: 999999;
  ">
    <strong>SIR Model</strong> · Version: <span id="app-version">…</span>
    · <span id="net-state">…</span>
  </div>
  <!-- Spacer so bar doesn't cover app -->
  <div style="height: 30px;"></div>

  <div style="height: calc(100vh - 30px); width: 100vw" id="root"></div>

<script>
  function updateStatus(extra) {
    const online = navigator.onLine ? "Online" : "Offline";
    const controlled = (navigator.serviceWorker && navigator.serviceWorker.controller) ? "SW controlling" : "SW not controlling";
    document.getElementById("net-state").textContent =
      extra ? `${online} · ${controlled} · ${extra}` : `${online} · ${controlled}`;
  }

  window.addEventListener("online", () => updateStatus());
  window.addEventListener("offline", () => updateStatus());
  updateStatus();

  async function requestSWVersion() {
    const el = document.getElementById("app-version");
    if (!("serviceWorker" in navigator)) { el.textContent = "(no SW)"; return; }

    // If not yet controlled, wait for controllerchange
    if (!navigator.serviceWorker.controller) {
      el.textContent = "(installing…)";
      return;
    }

    // Ask controller for version
    const chan = new MessageChannel();
    const timeout = setTimeout(() => {
      el.textContent = "(no reply)";
    }, 1500);

    chan.port1.onmessage = (e) => {
      clearTimeout(timeout);
      if (e.data && e.data.type === "VERSION") {
        el.textContent = e.data.version;
      } else {
        el.textContent = "(bad reply)";
      }
    };

    navigator.serviceWorker.controller.postMessage({ type: "GET_VERSION" }, [chan.port2]);
  }

  // First attempt
  requestSWVersion();

  // When SW takes control (often on 2nd load or after claim), try again
  navigator.serviceWorker?.addEventListener("controllerchange", () => {
    updateStatus("controller changed");
    requestSWVersion();
  });

  // Also retry shortly after load (covers races where controller appears moments later)
  setTimeout(requestSWVersion, 500);
  setTimeout(requestSWVersion, 1500);
</script>

</body>

</html>
